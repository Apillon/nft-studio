<template>
  <n-data-table
    :bordered="false"
    :columns="columns"
    :data="users"
    :pagination="{ pageSize: PaginationValues.PAGE_DEFAULT_LIMIT }"
  />
</template>

<script lang="ts" setup>
import { isAddress } from 'web3-validator';
import type { DataTableColumns } from 'naive-ui';
import { NInput, NInputNumber } from 'naive-ui';
import { PaginationValues } from '~/lib/values/general.values';

const props = defineProps({
  users: { type: Array<WhitelistUserInterface>, required: true },
});
const emit = defineEmits(['addUser', 'removeUser']);
const message = useMessage();

const newUser = ref<WhitelistUserInterface>({
  amount: 1,
  signature: null,
  wallet: null,
});

function isEditable(row: WhitelistUserInterface, index: number) {
  return !row.wallet && props.users.length === index + 1;
}

const createColumns = (): DataTableColumns<WhitelistUserInterface> => {
  return [
    {
      key: 'wallet',
      title: 'Wallet',
      minWidth: 100,
      render(row: WhitelistUserInterface, index: number) {
        if (isEditable(row, index)) {
          return h(NInput, {
            value: newUser.value.wallet,
            type: 'wallet',
            onUpdateValue(v: string) {
              newUser.value.wallet = v;
            },
          });
        } else {
          return h(resolveComponent('TableEllipsis'), { text: row.wallet }, '');
        }
      },
    },
    {
      key: 'amount',
      title: 'Amount',
      minWidth: 80,
      render(row: WhitelistUserInterface, index: number) {
        if (isEditable(row, index)) {
          return h(NInputNumber, {
            value: newUser.value.amount,
            type: 'email',
            min: 1,
            max: 100,
            step: 1,
            onUpdateValue(v) {
              newUser.value.amount = intVal(v || 0);
            },
          });
        } else {
          return h('span', { class: 'whitespace-nowrap' }, row.amount);
        }
      },
    },
    {
      key: 'signature',
      title: 'Signature',
      minWidth: 100,
      render(row: WhitelistUserInterface) {
        return h(resolveComponent('TableEllipsis'), { text: row.signature }, '');
      },
    },
    {
      key: 'action_remove',
      title: '',
      render(row: WhitelistUserInterface, index: number) {
        if (isEditable(row, index)) {
          return h('button', { class: 'icon-check text-xl text-green', onClick: () => addItem(row) }, '');
        } else if (!row.id) {
          return h('button', { class: 'icon-delete text-xl ', onClick: () => removeItem(row) }, '');
        }
        return '';
      },
    },
  ];
};
const columns = createColumns();

function addItem(user: WhitelistUserInterface) {
  if (!newUser.value.wallet) {
    message.warning('Please enter your wallet');
    return;
  } else if (!isAddress(newUser.value.wallet)) {
    message.warning('Wrong wallet address, please use EVM wallet');
    return;
  }

  user.amount = newUser.value.amount;
  user.signature = newUser.value.signature;
  user.wallet = newUser.value.wallet;

  newUser.value.amount = 1;
  newUser.value.signature = null;
  newUser.value.wallet = null;

  emit('addUser', newUser.value);
}

function removeItem(user: WhitelistUserInterface) {
  emit('removeUser', user.wallet);
}
</script>
