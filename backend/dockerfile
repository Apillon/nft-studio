
FROM node:16-alpine

# Application environment variables
ARG APP_ENV
ARG APP_SECRET
ARG APP_URL
ARG API_PORT
ARG API_HOST
ARG LOG_TARGET
ARG PAGE_DEFAULT_LIMIT
ARG PAGE_MAX_LIMIT

# MySQL configuration
ARG MYSQL_HOST
ARG MYSQL_PORT
ARG MYSQL_DATABASE
ARG MYSQL_USER
ARG MYSQL_PASSWORD
ARG MYSQL_POOL

ARG MYSQL_HOST_TEST
ARG MYSQL_PORT_TEST
ARG MYSQL_DATABASE_TEST
ARG MYSQL_USER_TEST
ARG MYSQL_PASSWORD_TEST
ARG MYSQL_POOL_TEST

# Admin settings
ARG ADMIN_WALLET

# Apillon integration
ARG APILLON_API_URL
ARG APILLON_KEY
ARG APILLON_SECRET
ARG COLLECTION_UUID
ARG MAX_SUPPLY

# SMTP configuration
ARG SMTP_HOST
ARG SMTP_PORT
ARG SMTP_USERNAME
ARG SMTP_PASSWORD
ARG SMTP_EMAIL_FROM
ARG SMTP_NAME_FROM
ARG SMTP_EMAIL_FROM_HELLO

# Additional features
ARG CAPTCHA_SECRET
ARG CLAIM_EXPIRES_IN
ARG SIGNATURE_PRIVATE_KEY
ARG SIGNATURE_CONTRACT_ADDRESS
ARG CLAIM_START

# Set environment variables from build args
ENV APP_ENV=$APP_ENV
ENV APP_SECRET=$APP_SECRET
ENV APP_URL=$APP_URL
ENV API_PORT=$API_PORT
ENV API_HOST=$API_HOST
ENV LOG_TARGET=$LOG_TARGET
ENV PAGE_DEFAULT_LIMIT=$PAGE_DEFAULT_LIMIT
ENV PAGE_MAX_LIMIT=$PAGE_MAX_LIMIT

ENV MYSQL_HOST=$MYSQL_HOST
ENV MYSQL_PORT=$MYSQL_PORT
ENV MYSQL_DATABASE=$MYSQL_DATABASE
ENV MYSQL_USER=$MYSQL_USER
ENV MYSQL_PASSWORD=$MYSQL_PASSWORD
ENV MYSQL_POOL=$MYSQL_POOL

ENV MYSQL_HOST_TEST=$MYSQL_HOST_TEST
ENV MYSQL_PORT_TEST=$MYSQL_PORT_TEST
ENV MYSQL_DATABASE_TEST=$MYSQL_DATABASE_TEST
ENV MYSQL_USER_TEST=$MYSQL_USER_TEST
ENV MYSQL_PASSWORD_TEST=$MYSQL_PASSWORD_TEST
ENV MYSQL_POOL_TEST=$MYSQL_POOL_TEST

ENV ADMIN_WALLET=$ADMIN_WALLET

ENV APILLON_API_URL=$APILLON_API_URL
ENV APILLON_KEY=$APILLON_KEY
ENV APILLON_SECRET=$APILLON_SECRET
ENV COLLECTION_UUID=$COLLECTION_UUID
ENV MAX_SUPPLY=$MAX_SUPPLY

ENV SMTP_HOST=$SMTP_HOST
ENV SMTP_PORT=$SMTP_PORT
ENV SMTP_USERNAME=$SMTP_USERNAME
ENV SMTP_PASSWORD=$SMTP_PASSWORD
ENV SMTP_EMAIL_FROM=$SMTP_EMAIL_FROM
ENV SMTP_NAME_FROM=$SMTP_NAME_FROM
ENV SMTP_EMAIL_FROM_HELLO=$SMTP_EMAIL_FROM_HELLO

ENV CAPTCHA_SECRET=$CAPTCHA_SECRET
ENV CLAIM_EXPIRES_IN=$CLAIM_EXPIRES_IN
ENV SIGNATURE_PRIVATE_KEY=$SIGNATURE_PRIVATE_KEY
ENV SIGNATURE_CONTRACT_ADDRESS=$SIGNATURE_CONTRACT_ADDRESS
ENV CLAIM_START=$CLAIM_START

ENV appDir /app
RUN mkdir -p /app

WORKDIR ${appDir}

# Install MySQL client
RUN apk --no-cache add mysql-client

RUN npm install -g typescript pm2@latest

ADD ./package-lock.json ${appDir}
ADD ./package.json ${appDir}
ADD ./ ${appDir}/

RUN npm install 
RUN npm run build
RUN mkdir -p ./dist/templates/mail/ 
RUN cp ./src/templates/mail/*.html ./dist/templates/mail/

EXPOSE ${API_PORT}
RUN chmod +x ./bin/docker-start.sh
CMD ["./bin/docker-start.sh"]